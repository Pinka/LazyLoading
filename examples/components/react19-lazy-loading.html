<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Modern React Lazy Loading</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        line-height: 1.6;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }

      h1,
      h2,
      h3 {
        color: #333;
      }

      .explanation {
        background-color: #f8f9fa;
        border-left: 4px solid #007bff;
        padding: 15px;
        margin-bottom: 20px;
      }

      pre {
        background-color: #f1f1f1;
        padding: 15px;
        border-radius: 4px;
        overflow-x: auto;
        font-family: monospace;
        white-space: pre-wrap;
      }

      code {
        background-color: #f1f1f1;
        padding: 2px 4px;
        border-radius: 4px;
        font-family: monospace;
      }

      .feature-section {
        margin-bottom: 30px;
        padding: 20px;
        background-color: #fff;
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .feature-section h2 {
        color: #007bff;
        margin-top: 0;
      }

      .note {
        background-color: #fffde7;
        border-left: 4px solid #ffd600;
        padding: 15px;
        margin: 15px 0;
      }

      .highlight {
        background-color: #e8f5e9;
        border-left: 4px solid #4caf50;
        padding: 15px;
        margin: 15px 0;
      }

      .back-link {
        display: inline-block;
        margin-top: 20px;
        color: #007bff;
        text-decoration: none;
      }

      .back-link:hover {
        text-decoration: underline;
      }

      .file-structure {
        background-color: #f5f5f5;
        padding: 15px;
        border-radius: 4px;
        margin: 15px 0;
        font-family: monospace;
      }
    </style>
  </head>
  <body>
    <h1>Modern React Lazy Loading Features</h1>

    <div class="explanation">
      <h2>Overview</h2>
      <p>
        Modern React introduces several improvements to lazy loading and code
        splitting capabilities. This document demonstrates the key features with
        actual React code examples.
      </p>
      <p>
        Note: These examples are designed to be copied into a React project. To
        run them, you'll need a React application with the latest features
        enabled.
      </p>
    </div>

    <div class="file-structure">
      <h3>Project Structure</h3>
      <pre>
my-react-app/
├── src/
│   ├── App.js                 # Main application component
│   │   ├── LazyComponent.js   # Component to be lazy loaded
│   │   ├── Header.js          # Header component
│   │   ├── MainContent.js     # Main content component
│   │   ├── Sidebar.js         # Sidebar component
│   │   └── Footer.js          # Footer component
│   ├── server/
│   │   └── server.js          # Server-side rendering setup
│   └── index.js               # Entry point
└── package.json               # Dependencies
      </pre>
    </div>

    <div class="feature-section">
      <h2>1. Enhanced Suspense</h2>
      <p>
        Modern React improves the Suspense component with better error handling
        and more control over fallback states.
      </p>

      <pre>
// App.js
import React, { Suspense, lazy, useState } from 'react';
import './App.css';

// Lazy load component
const LazyComponent = lazy(() => import('./components/LazyComponent'));

// Error logging function
const logError = (error) => {
  console.error('Component failed to load:', error);
  // In production, you might send this to an error tracking service
  // errorTrackingService.captureException(error);
};

function App() {
  const [showLazyComponent, setShowLazyComponent] = useState(false);
  
  return (
    &lt;div className="App"&gt;
      &lt;h1&gt;Enhanced Suspense Example&lt;/h1&gt;
      
      &lt;button 
        onClick={() => setShowLazyComponent(true)}
        disabled={showLazyComponent}
      &gt;
        Load Component
      &lt;/button&gt;
      
      {showLazyComponent && (
        &lt;Suspense 
          fallback={&lt;div className="loading-indicator"&gt;Loading...&lt;/div&gt;}
          fallbackMinDuration={500} // Prevents flash of loading state for fast loads
          fallbackMaxDuration={5000} // Shows error UI after timeout
          onError={(error) => logError(error)}
        &gt;
          &lt;LazyComponent /&gt;
        &lt;/Suspense&gt;
      )}
    &lt;/div&gt;
  );
}

export default App;

// components/LazyComponent.js
import React, { useEffect, useState } from 'react';

function LazyComponent() {
  const [data, setData] = useState(null);
  
  useEffect(() => {
    // Simulate data fetching
    const fetchData = async () => {
      try {
        // Simulate API call
        await new Promise(resolve => setTimeout(resolve, 1000));
        setData({
          title: 'Lazy Loaded Component',
          description: 'This component was loaded on demand!'
        });
      } catch (error) {
        console.error('Error fetching data:', error);
      }
    };
    
    fetchData();
  }, []);
  
  return (
    &lt;div className="lazy-component"&gt;
      {data ? (
        &lt;&gt;
          &lt;h2&gt;{data.title}&lt;/h2&gt;
          &lt;p&gt;{data.description}&lt;/p&gt;
          &lt;p&gt;Successfully loaded at: {new Date().toLocaleTimeString()}&lt;/p&gt;
        &lt;/&gt;
      ) : (
        &lt;p&gt;Loading data...&lt;/p&gt;
      )}
    &lt;/div&gt;
  );
}

export default LazyComponent;
      </pre>

      <div class="highlight">
        <strong>Key Improvements:</strong>
        <ul>
          <li>
            <code>fallbackMinDuration</code>: Prevents "flash of loading state"
            for fast-loading components
          </li>
          <li>
            <code>fallbackMaxDuration</code>: Sets a timeout after which to show
            an error state
          </li>
          <li>
            <code>onError</code>: Callback for error handling with detailed
            error information
          </li>
        </ul>
      </div>
    </div>

    <div class="feature-section">
      <h2>2. Nested Suspense Boundaries</h2>
      <p>
        Modern React improves handling of nested Suspense boundaries, allowing
        for more granular loading states.
      </p>

      <pre>
// App.js
import React, { Suspense, lazy } from 'react';
import './App.css';

// Lazy load components
const LazyHeader = lazy(() => import('./components/Header'));
const LazyMainContent = lazy(() => import('./components/MainContent'));
const LazySidebar = lazy(() => import('./components/Sidebar'));
const LazyFooter = lazy(() => import('./components/Footer'));

// Loading skeletons
const PageSkeleton = () => &lt;div className="skeleton page-skeleton"&gt;Loading page...&lt;/div&gt;;
const ContentSkeleton = () => &lt;div className="skeleton content-skeleton"&gt;Loading content...&lt;/div&gt;;
const SidebarSkeleton = () => &lt;div className="skeleton sidebar-skeleton"&gt;Loading sidebar...&lt;/div&gt;;

function App() {
  return (
    &lt;div className="app"&gt;
      &lt;Suspense fallback={&lt;PageSkeleton /&gt;}&gt;
        &lt;LazyHeader /&gt;
        
        &lt;div className="content-wrapper"&gt;
          &lt;Suspense fallback={&lt;ContentSkeleton /&gt;}&gt;
            &lt;LazyMainContent /&gt;
          &lt;/Suspense&gt;
          
          &lt;Suspense fallback={&lt;SidebarSkeleton /&gt;}&gt;
            &lt;LazySidebar /&gt;
          &lt;/Suspense&gt;
        &lt;/div&gt;
        
        &lt;LazyFooter /&gt;
      &lt;/Suspense&gt;
    &lt;/div&gt;
  );
}

export default App;

// components/Header.js
import React from 'react';

function Header() {
  return (
    &lt;header&gt;
      &lt;h1&gt;My Application&lt;/h1&gt;
      &lt;nav&gt;
        &lt;ul&gt;
          &lt;li&gt;&lt;a href="#"&gt;Home&lt;/a&gt;&lt;/li&gt;
          &lt;li&gt;&lt;a href="#"&gt;About&lt;/a&gt;&lt;/li&gt;
          &lt;li&gt;&lt;a href="#"&gt;Contact&lt;/a&gt;&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/nav&gt;
    &lt;/header&gt;
  );
}

export default Header;

// components/MainContent.js
import React, { useEffect, useState } from 'react';

function MainContent() {
  const [articles, setArticles] = useState([]);
  
  useEffect(() => {
    // Simulate fetching articles
    const fetchArticles = async () => {
      // Simulate API delay
      await new Promise(resolve => setTimeout(resolve, 1500));
      
      setArticles([
        { id: 1, title: 'Understanding Lazy Loading', excerpt: 'Learn about lazy loading techniques...' },
        { id: 2, title: 'React Performance Tips', excerpt: 'Optimize your React applications...' },
        { id: 3, title: 'Modern Web Development', excerpt: 'Explore the latest trends...' }
      ]);
    };
    
    fetchArticles();
  }, []);
  
  return (
    &lt;main&gt;
      &lt;h2&gt;Latest Articles&lt;/h2&gt;
      {articles.length > 0 ? (
        &lt;div className="articles"&gt;
          {articles.map(article => (
            &lt;article key={article.id}&gt;
              &lt;h3&gt;{article.title}&lt;/h3&gt;
              &lt;p&gt;{article.excerpt}&lt;/p&gt;
              &lt;a href="#"&gt;Read more&lt;/a&gt;
            &lt;/article&gt;
          ))}
        &lt;/div&gt;
      ) : (
        &lt;p&gt;Loading articles...&lt;/p&gt;
      )}
    &lt;/main&gt;
  );
}

export default MainContent;
      </pre>

      <div class="note">
        <p>
          This approach allows different parts of the page to load
          independently. The header and footer might load first, while the main
          content and sidebar load in parallel afterward.
        </p>
        <p>
          In a real application, you would also implement the Sidebar and Footer
          components in a similar way.
        </p>
      </div>
    </div>

    <div class="feature-section">
      <h2>3. Server Components</h2>
      <p>
        Modern React introduces Server Components, which run exclusively on the
        server and send only the rendered HTML to the client, reducing
        JavaScript bundle size.
      </p>

      <pre>
// ServerComponent.jsx - This component never gets sent to the client as JS
// Note the absence of 'use client' directive
import { db } from '../lib/database';

export default async function ServerComponent() {
  // Data fetching happens on the server
  const data = await db.articles.findMany({
    where: { published: true },
    orderBy: { createdAt: 'desc' },
    take: 10
  });
  
  return (
    &lt;div className="server-rendered"&gt;
      &lt;h2&gt;Latest Articles&lt;/h2&gt;
      &lt;div className="article-grid"&gt;
        {data.map(article => (
          &lt;div key={article.id} className="article-card"&gt;
            &lt;h3&gt;{article.title}&lt;/h3&gt;
            &lt;p&gt;{article.excerpt}&lt;/p&gt;
            &lt;div className="article-meta"&gt;
              &lt;span&gt;By {article.author.name}&lt;/span&gt;
              &lt;span&gt;{new Date(article.createdAt).toLocaleDateString()}&lt;/span&gt;
            &lt;/div&gt;
          &lt;/div&gt;
        ))}
      &lt;/div&gt;
    &lt;/div&gt;
  );
}

// App.jsx - Client component that uses the server component
'use client';

import { useState } from 'react';
import ServerComponent from './ServerComponent';

export default function App() {
  const [showThankYou, setShowThankYou] = useState(false);
  
  return (
    &lt;div className="app-container"&gt;
      &lt;h1&gt;My Blog&lt;/h1&gt;
      
      {/* Server component is rendered on the server */}
      &lt;ServerComponent /&gt;
      
      {/* Client-side interactivity */}
      &lt;div className="newsletter-signup"&gt;
        {showThankYou ? (
          &lt;p&gt;Thanks for subscribing!&lt;/p&gt;
        ) : (
          &lt;&gt;
            &lt;h3&gt;Subscribe to our newsletter&lt;/h3&gt;
            &lt;form onSubmit={(e) => {
              e.preventDefault();
              setShowThankYou(true);
            }}&gt;
              &lt;input type="email" placeholder="Your email" required /&gt;
              &lt;button type="submit"&gt;Subscribe&lt;/button&gt;
            &lt;/form&gt;
          &lt;/&gt;
        )}
      &lt;/div&gt;
    &lt;/div&gt;
  );
}
      </pre>

      <div class="highlight">
        <strong>Benefits:</strong>
        <ul>
          <li>Zero JavaScript bundle size for server components</li>
          <li>
            Data fetching happens on the server, closer to the data source
          </li>
          <li>Reduced client-side processing</li>
          <li>Better performance on low-powered devices</li>
        </ul>
      </div>
    </div>

    <div class="feature-section">
      <h2>4. Asset Loading Optimization</h2>
      <p>
        Modern React includes built-in optimizations for loading assets like
        images, with native lazy loading support.
      </p>

      <pre>
// ImageGallery.jsx
import React from 'react';
import { Image } from 'next/image'; // Using Next.js Image component

function ImageGallery({ images }) {
  // Featured image that should load immediately
  const featuredImage = images[0];
  
  // Rest of the gallery images
  const galleryImages = images.slice(1);
  
  return (
    &lt;div className="gallery"&gt;
      &lt;h2&gt;Photo Gallery&lt;/h2&gt;
      
      {/* Hero image loads immediately with high priority */}
      &lt;div className="featured-image"&gt;
        &lt;Image 
          src={featuredImage.src}
          width={1200}
          height={600}
          alt={featuredImage.alt}
          priority={true} // Equivalent to fetchPriority="high"
          placeholder="blur"
          blurDataURL={featuredImage.blurDataUrl}
        /&gt;
        &lt;p className="caption"&gt;{featuredImage.caption}&lt;/p&gt;
      &lt;/div&gt;
      
      &lt;div className="gallery-grid"&gt;
        {galleryImages.map(image => (
          &lt;div key={image.id} className="gallery-item"&gt;
            &lt;Image 
              src={image.src}
              width={300}
              height={200}
              alt={image.alt}
              loading="lazy" // Only loads when near viewport
              placeholder="blur"
              blurDataURL={image.blurDataUrl}
            /&gt;
            &lt;p className="caption"&gt;{image.caption}&lt;/p&gt;
          &lt;/div&gt;
        ))}
      &lt;/div&gt;
    &lt;/div&gt;
  );
}

// Usage example
export default function GalleryPage() {
  const images = [
    {
      id: 1,
      src: '/images/featured.jpg',
      alt: 'Featured image',
      caption: 'Beautiful landscape',
      blurDataUrl: 'data:image/jpeg;base64,/9j...' // Base64 encoded tiny image
    },
    // More images...
  ];
  
  return (
    &lt;div className="container"&gt;
      &lt;h1&gt;Our Photography&lt;/h1&gt;
      &lt;ImageGallery images={images} /&gt;
    &lt;/div&gt;
  );
}
      </pre>

      <div class="note">
        <p>
          The Next.js <code>Image</code> component provides built-in
          optimizations like:
        </p>
        <ul>
          <li>
            Automatic lazy loading with the
            <code>loading="lazy"</code> attribute
          </li>
          <li>Priority loading with <code>priority</code> prop</li>
          <li>Automatic image size optimization and WebP/AVIF conversion</li>
          <li>Preventing layout shifts with proper placeholder handling</li>
          <li>Blur-up technique with <code>placeholder="blur"</code></li>
        </ul>
      </div>
    </div>

    <div class="feature-section">
      <h2>5. Streaming SSR</h2>
      <p>
        Modern React enhances streaming Server-Side Rendering to progressively
        load page content.
      </p>

      <pre>
// server.js (Node.js with Express)
import express from 'express';
import { renderToPipeableStream } from 'react-dom/server';
import { StaticRouter } from 'react-router-dom/server';
import App from '../App';

const app = express();

// Serve static files
app.use(express.static('build/client'));

app.get('*', (req, res) => {
  // Set appropriate headers
  res.setHeader('Content-Type', 'text/html');
  
  let didError = false;
  
  // Create the stream
  const { pipe, abort } = renderToPipeableStream(
    &lt;StaticRouter location={req.url}&gt;
      &lt;App /&gt;
    &lt;/StaticRouter&gt;,
    {
      bootstrapScripts: ['/main.js'],
      
      // Called when the shell (the minimal HTML) is ready
      onShellReady() {
        // If something errored before the shell was ready, abort and send fallback HTML
        if (didError) {
          return;
        }
        
        res.statusCode = 200;
        pipe(res);
      },
      
      // Called when all Suspense boundaries are resolved
      onAllReady() {
        // If we were generating a static HTML file, we'd write the full HTML here
        // For streaming, we've already started piping in onShellReady
      },
      
      // Called when an error occurs during rendering
      onError(error) {
        didError = true;
        console.error('Error during rendering:', error);
        
        // If the shell hasn't been sent yet, we can send a fallback HTML
        if (res.headersSent) {
          abort();
        } else {
          res.statusCode = 500;
          res.send('&lt;html&gt;&lt;body&gt;&lt;h1&gt;Something went wrong&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;');
        }
      }
    }
  );
  
  // Set a timeout to abort rendering if it takes too long
  setTimeout(() => {
    abort();
  }, 10000);
});

// Start the server
app.listen(3000, () => {
  console.log('Server running at http://localhost:3000');
});

// App.js with Suspense boundaries
import React, { Suspense, lazy } from 'react';
import { Routes, Route } from 'react-router-dom';
import Header from './components/Header';

// Lazy-loaded route components
const Home = lazy(() => import('./pages/Home'));
const About = lazy(() => import('./pages/About'));
const Products = lazy(() => import('./pages/Products'));

function App() {
  return (
    &lt;&gt;
      &lt;Header /&gt;
      
      &lt;main&gt;
        &lt;Suspense fallback={&lt;div&gt;Loading page...&lt;/div&gt;}&gt;
          &lt;Routes&gt;
            &lt;Route path="/" element={&lt;Home /&gt;} /&gt;
            &lt;Route path="/about" element={&lt;About /&gt;} /&gt;
            &lt;Route path="/products" element={&lt;Products /&gt;} /&gt;
          &lt;/Routes&gt;
        &lt;/Suspense&gt;
      &lt;/main&gt;
      
      &lt;footer&gt;© {new Date().getFullYear()} My Company&lt;/footer&gt;
    &lt;/&gt;
  );
}

export default App;
      </pre>

      <div class="highlight">
        <strong>How it works:</strong>
        <ol>
          <li>
            The server immediately sends the HTML "shell" (layout, header,
            navigation)
          </li>
          <li>The rest of the content streams in as it becomes available</li>
          <li>
            React on the client "hydrates" the streamed HTML to make it
            interactive
          </li>
          <li>
            Users see content sooner and can interact with parts of the page as
            they load
          </li>
        </ol>
      </div>
    </div>

    <div class="feature-section">
      <h2>6. Simplified Code Splitting</h2>
      <p>
        Modern React simplifies code splitting with improved APIs for
        component-level splitting.
      </p>

      <pre>
// Traditional approach
import React, { lazy, Suspense } from 'react';

// Lazy load a heavy component
const DataGrid = lazy(() => import('./components/DataGrid'));

function Dashboard() {
  const [showDataGrid, setShowDataGrid] = useState(false);
  
  return (
    &lt;div className="dashboard"&gt;
      &lt;h1&gt;Dashboard&lt;/h1&gt;
      
      &lt;button onClick={() => setShowDataGrid(true)}&gt;
        Show Data Grid
      &lt;/button&gt;
      
      {showDataGrid && (
        &lt;Suspense fallback={&lt;div&gt;Loading data grid...&lt;/div&gt;}&gt;
          &lt;DataGrid data={someData} /&gt;
        &lt;/Suspense&gt;
      )}
    &lt;/div&gt;
  );
}

// Modern approach with simplified API
import React, { useState } from 'react';
import { lazy } from 'react';

// Simplified lazy API with automatic Suspense boundary
const DataGrid = lazy('./components/DataGrid', {
  fallback: &lt;div&gt;Loading data grid...&lt;/div&gt;,
  onError: (error) => {
    console.error('Failed to load DataGrid:', error);
    // You could also show a user-friendly error message
  }
});

function Dashboard() {
  const [showDataGrid, setShowDataGrid] = useState(false);
  
  return (
    &lt;div className="dashboard"&gt;
      &lt;h1&gt;Dashboard&lt;/h1&gt;
      
      &lt;button onClick={() => setShowDataGrid(true)}&gt;
        Show Data Grid
      &lt;/button&gt;
      
      {showDataGrid && &lt;DataGrid data={someData} /&gt;}
    &lt;/div&gt;
  );
}

// components/DataGrid.js - The lazy-loaded component
import React, { useState, useEffect } from 'react';

function DataGrid({ data }) {
  const [sortedData, setSortedData] = useState([]);
  const [sortField, setSortField] = useState('id');
  const [sortDirection, setSortDirection] = useState('asc');
  
  useEffect(() => {
    // Sort the data based on current sort settings
    const sorted = [...data].sort((a, b) => {
      if (a[sortField] < b[sortField]) return sortDirection === 'asc' ? -1 : 1;
      if (a[sortField] > b[sortField]) return sortDirection === 'asc' ? 1 : -1;
      return 0;
    });
    
    setSortedData(sorted);
  }, [data, sortField, sortDirection]);
  
  const handleSort = (field) => {
    if (field === sortField) {
      // Toggle direction if same field
      setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
    } else {
      // New field, default to ascending
      setSortField(field);
      setSortDirection('asc');
    }
  };
  
  return (
    &lt;div className="data-grid"&gt;
      &lt;table&gt;
        &lt;thead&gt;
          &lt;tr&gt;
            {Object.keys(data[0] || {}).map(key => (
              &lt;th key={key} onClick={() => handleSort(key)}&gt;
                {key} {sortField === key && (sortDirection === 'asc' ? '↑' : '↓')}
              &lt;/th&gt;
            ))}
          &lt;/tr&gt;
        &lt;/thead&gt;
        &lt;tbody&gt;
          {sortedData.map((row, index) => (
            &lt;tr key={index}&gt;
              {Object.values(row).map((value, i) => (
                &lt;td key={i}&gt;{value}&lt;/td&gt;
              ))}
            &lt;/tr&gt;
          ))}
        &lt;/tbody&gt;
      &lt;/table&gt;
    &lt;/div&gt;
  );
}

export default DataGrid;
      </pre>

      <div class="note">
        <p>Modern React simplifies the lazy loading API by:</p>
        <ul>
          <li>Allowing direct path strings instead of import functions</li>
          <li>Providing fallback and error handling in the lazy call itself</li>
          <li>Creating implicit Suspense boundaries when needed</li>
        </ul>
      </div>
    </div>

    <p><a href="../index.html" class="back-link">← Back to Examples</a></p>
  </body>
</html>
